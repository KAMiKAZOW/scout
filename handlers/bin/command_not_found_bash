command_not_found_handle() {

    local cmd state rest
    local -i pid ppid pgrp session tty_nr tpgid 

    # do not run when inside Midnight Commander or within a Pipe
    if test -n "$MC_SID" -o ! -t 1 ; then
        return 127
    fi

    # do not run when within a subshell
    read pid cmd state ppid pgrp session tty_nr tpgid rest  < /proc/self/stat
    if test $$ -eq $tpgid; then
        return 127
    fi

    # run command-not-found program
    test -x /usr/bin/python && test -x /usr/bin/command-not-found && /usr/bin/python /usr/bin/command-not-found "$@" __REPO__ || return 127

}
